<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>TEST GAMBAR - TK</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;font-family:sans-serif;background:linear-gradient(180deg,#fff6e5,#fde2e4)}
  #menu,#toolbar{display:flex;justify-content:center;gap:12px;padding:10px;background:#fff}
  #menu button{font-size:18px;padding:10px 16px;border:none;border-radius:14px;background:#ffd966}
  #menu button.disabled{opacity:.4}
  #toolbar{display:none}
  .color{width:28px;height:28px;border-radius:50%;border:2px solid #ccc}
  button{font-size:18px;padding:8px 12px;border:none;border-radius:12px;background:#ffd966}
  button.disabled{opacity:.4}
  canvas{display:none;margin:10px auto;background:#fffaf3;border-radius:16px;border:2px dashed #f5cba7;touch-action:none}
</style>
</head>
<body>

<div id="menu">
  <button onclick="startTK()">üé® Warnai</button>
  <button class="disabled">‚úèÔ∏è Gambar</button>
</div>

<canvas id="canvas" width="360" height="420"></canvas>

<div id="toolbar">
  <div class="color" style="background:#000" onclick="setColor('#000')"></div>
  <div class="color" style="background:red" onclick="setColor('red')"></div>
  <div class="color" style="background:orange" onclick="setColor('orange')"></div>
  <div class="color" style="background:yellow" onclick="setColor('yellow')"></div>
  <div class="color" style="background:green" onclick="setColor('green')"></div>
  <div class="color" style="background:blue" onclick="setColor('blue')"></div>
  <button onclick="setTool('erase')">üßΩ</button>
  <button id="playBtn" class="disabled" onclick="onPlay()">‚ñ∂Ô∏è</button>
</div>

<script>
/* ===== STATE ===== */
let mode=null, activeTool='marker', selectedColor='red';
let coloredAreaCount=0, isPlaying=false;

/* ===== VOICE ===== */
function speak(t){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t);
  u.lang='id-ID'; u.rate=.9; speechSynthesis.speak(u);
}

/* ===== CANVAS ===== */
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');

/* ===== AREAS (FULL OBJECT) ===== */
const DEF='#eee';
const areas={
  head:{hit:(x,y)=>dist(x,y,180,120)<55, color:null},
  earsL:{hit:(x,y)=>polyHit(x,y,[[135,70],[160,40],[175,90]]), color:null},
  earsR:{hit:(x,y)=>polyHit(x,y,[[185,90],[200,40],[225,70]]), color:null},
  body:{hit:(x,y)=>dist(x,y,180,260)<90, color:null},
  legL:{hit:(x,y)=>rectHit(x,y,135,330,30,60), color:null},
  legR:{hit:(x,y)=>rectHit(x,y,195,330,30,60), color:null},
  tail:{hit:(x,y)=>dist(x,y,245,260)<30, color:null}
};

/* ===== START TK ===== */
function startTK(){
  mode='tk';
  document.getElementById('menu').style.display='none';
  canvas.style.display='block';
  document.getElementById('toolbar').style.display='flex';
  drawCat();
  speak('Pilih warna, lalu warnai gambarnya.');
}

/* ===== DRAW FULL CAT ===== */
function drawCat(offsetY=0){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth=4; ctx.strokeStyle='#000';

  // ears
  fillPoly([[135,70+offsetY],[160,40+offsetY],[175,90+offsetY]], areas.earsL.color||DEF);
  fillPoly([[185,90+offsetY],[200,40+offsetY],[225,70+offsetY]], areas.earsR.color||DEF);

  // head
  fillCircle(180,120+offsetY,55, areas.head.color||DEF);

  // body
  fillEllipse(180,260+offsetY,80,95, areas.body.color||DEF);

  // legs
  fillRect(135,330+offsetY,30,60, areas.legL.color||DEF);
  fillRect(195,330+offsetY,30,60, areas.legR.color||DEF);

  // tail
  ctx.fillStyle=areas.tail.color||DEF;
  ctx.beginPath(); ctx.arc(245,260+offsetY,28,0,Math.PI*2); ctx.fill(); ctx.stroke();
}

/* ===== INPUT ===== */
canvas.onclick=(e)=>{
  if(isPlaying||mode!=='tk')return;
  const x=e.offsetX,y=e.offsetY;

  if(activeTool==='marker'){
    for(const k in areas){
      if(areas[k].hit(x,y)){
        if(!areas[k].color){ coloredAreaCount++; checkPlayEnable(); }
        areas[k].color=selectedColor;
        drawCat(); microBounce(); break;
      }
    }
  }

  if(activeTool==='erase'){
    for(const k in areas){
      if(areas[k].hit(x,y) && areas[k].color){
        areas[k].color=null; coloredAreaCount--;
        checkPlayEnable(); drawCat(); break;
      }
    }
  }
};

/* ===== TOOLS ===== */
function setColor(c){ activeTool='marker'; selectedColor=c; }
function setTool(t){ activeTool=t; if(t==='erase')speak('Sentuh warna yang mau dihapus.'); }

/* ===== PLAY ===== */
function checkPlayEnable(){
  const b=document.getElementById('playBtn');
  coloredAreaCount>=1 ? b.classList.remove('disabled') : b.classList.add('disabled');
}
function onPlay(){
  if(coloredAreaCount<1){ speak('Warnai dulu gambarnya ya.'); return; }
  isPlaying=true; speak('Lihat, gambarnya hidup!');
  animate(); setTimeout(()=>{isPlaying=false; drawCat();},4000);
}

/* ===== ANIM ===== */
function animate(){
  let t=0; const id=setInterval(()=>{
    t++; drawCat(Math.sin(t)*8);
    if(t>24)clearInterval(id);
  },100);
}
function microBounce(){ /* kecil, cepat */ }

/* ===== GEOM HELPERS ===== */
function dist(x,y,cx,cy){return Math.hypot(x-cx,y-cy)}
function rectHit(x,y,rx,ry,w,h){return x>rx&&x<rx+w&&y>ry&&y<ry+h}
function polyHit(x,y,p){
  let c=false; for(let i=0,j=p.length-1;i<p.length;j=i++)
    ((p[i][1]>y)!==(p[j][1]>y))&&(x<(p[j][0]-p[i][0])*(y-p[i][1])/(p[j][1]-p[i][1])+p[i][0])&&(c=!c);
  return c;
}
function fillCircle(cx,cy,r,col){ctx.fillStyle=col;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();ctx.stroke()}
function fillEllipse(cx,cy,rx,ry,col){ctx.fillStyle=col;ctx.beginPath();ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);ctx.fill();ctx.stroke()}
function fillRect(x,y,w,h,col){ctx.fillStyle=col;ctx.fillRect(x,y,w,h);ctx.strokeRect(x,y,w,h)}
function fillPoly(p,col){ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(p[0][0],p[0][1]);p.slice(1).forEach(q=>ctx.lineTo(q[0],q[1]));ctx.closePath();ctx.fill();ctx.stroke()}
</script>
</body>
</html>
